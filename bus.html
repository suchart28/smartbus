<!DOCTYPE html>
<html lang="th">
<head>
<meta charset="UTF-8">
<title>Bus Location Sender</title>
<meta name="viewport" content="width=device-width, initial-scale=1.0">

<style>
    body {
        font-family: sans-serif;
        background: #003049;
        color: #fff;
        margin: 0;
        padding: 0;
        text-align: center;
    }

    h1 {
        font-size: 2.6rem;
        font-weight: bold;
        margin-top: 25px;
        color: #ffdd57;
    }

    input {
        width: 80%;
        padding: 18px;
        font-size: 2.2rem;
        border-radius: 12px;
        border: none;
        margin: 20px 0;
        text-align: center;
    }

    .status {
        font-size: 2rem;
        margin: 20px 0;
        padding: 12px;
        border-radius: 12px;
        background: #1a759f;
        display: inline-block;
        width: 80%;
    }

    .coords {
        font-size: 1.8rem;
        margin: 12px 0;
    }

    button {
        width: 90%;
        padding: 22px;
        font-size: 2.4rem;
        border-radius: 15px;
        background: #2a9d8f;
        color: #fff;
        border: none;
        margin-top: 25px;
        cursor: pointer;
        font-weight: bold;
    }

    button:active {
        background: #21867a;
    }
</style>

</head>
<body>

<h1>üöç ‡∏™‡πà‡∏á‡∏ï‡∏≥‡πÅ‡∏´‡∏ô‡πà‡∏á‡∏£‡∏ñ‡∏ö‡∏±‡∏™</h1>

<input type="text" id="busId" placeholder="‡∏Å‡∏£‡∏≠‡∏Å‡∏£‡∏´‡∏±‡∏™‡∏£‡∏ñ‡∏ö‡∏±‡∏™ ‡πÄ‡∏ä‡πà‡∏ô 23">

<div class="status" id="statusText">‡∏£‡∏≠‡∏Å‡∏≤‡∏£‡∏™‡πà‡∏á‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•...</div>
<div class="coords" id="coordsText">-</div>

<button onclick="sendLocation()">‡∏™‡πà‡∏á‡∏ï‡∏≥‡πÅ‡∏´‡∏ô‡πà‡∏á‡∏ó‡∏±‡∏ô‡∏ó‡∏µ</button>
<button onclick="enableWakeLock()">üîí ‡∏õ‡πâ‡∏≠‡∏á‡∏Å‡∏±‡∏ô‡∏´‡∏ô‡πâ‡∏≤‡∏à‡∏≠‡∏î‡∏±‡∏ö</button>

<script>
// ‚úÖ ‡πÉ‡∏ä‡πâ URL ‡∏à‡∏£‡∏¥‡∏á‡∏Ç‡∏≠‡∏á‡∏Ñ‡∏∏‡∏ì‡πÅ‡∏•‡πâ‡∏ß
const API_URL = "https://script.google.com/macros/s/AKfycbyLjvcISXszJazY6QFkaioay9qhZwZkW2eH8fxX3REdP-tJPf9PYn-BQrI9RmF0jUBudQ/exec";

document.getElementById("busId").value = localStorage.getItem("busId") || "";

function sendLocation() {
    const busId = document.getElementById("busId").value.trim();

    if (!busId) {
        document.getElementById("statusText").textContent = "‚ö†Ô∏è ‡∏Å‡∏£‡∏∏‡∏ì‡∏≤‡∏Å‡∏£‡∏≠‡∏Å‡∏£‡∏´‡∏±‡∏™‡∏£‡∏ñ‡∏Å‡πà‡∏≠‡∏ô‡∏™‡πà‡∏á";
        return;
    }

    localStorage.setItem("busId", busId);

    navigator.geolocation.getCurrentPosition(pos => {
        const lat = pos.coords.latitude;
        const lon = pos.coords.longitude;

        document.getElementById("coordsText").textContent =
            `üåè ${lat.toFixed(5)}, ${lon.toFixed(5)}`;

        fetch(`${API_URL}?bus=${busId}&lat=${lat}&lon=${lon}`)
            .then(response => {
                if (response.ok) {
                    document.getElementById("statusText").textContent = "‚úÖ ‡∏™‡πà‡∏á‡∏™‡∏≥‡πÄ‡∏£‡πá‡∏à‡πÅ‡∏•‡πâ‡∏ß";
                } else {
                    document.getElementById("statusText").textContent = "‚ùå ‡πÄ‡∏ã‡∏¥‡∏£‡πå‡∏ü‡πÄ‡∏ß‡∏≠‡∏£‡πå‡∏ï‡∏≠‡∏ö‡∏Å‡∏•‡∏±‡∏ö‡∏ú‡∏¥‡∏î‡∏û‡∏•‡∏≤‡∏î";
                }
            })
            .catch(() => {
                document.getElementById("statusText").textContent = "‚ùå ‡∏™‡πà‡∏á‡πÑ‡∏°‡πà‡∏™‡∏≥‡πÄ‡∏£‡πá‡∏à (‡∏ï‡∏£‡∏ß‡∏à‡πÄ‡∏ô‡πá‡∏ï‡∏´‡∏£‡∏∑‡∏≠‡∏™‡∏±‡∏ç‡∏ç‡∏≤‡∏ì)";
            });

    }, () => {
        document.getElementById("statusText").textContent = "‚ö†Ô∏è ‡πÄ‡∏õ‡∏¥‡∏î‡∏Å‡∏≤‡∏£‡πÅ‡∏ä‡∏£‡πå‡∏ï‡∏≥‡πÅ‡∏´‡∏ô‡πà‡∏á‡∏Å‡πà‡∏≠‡∏ô";
    });
}

// ‡∏™‡πà‡∏á‡∏≠‡∏±‡∏ï‡πÇ‡∏ô‡∏°‡∏±‡∏ï‡∏¥‡∏ó‡∏∏‡∏Å 2 ‡∏ô‡∏≤‡∏ó‡∏µ
setInterval(sendLocation, 2 * 60 * 1000);
sendLocation();

// üîí ‡∏Å‡∏±‡∏ô‡∏´‡∏ô‡πâ‡∏≤‡∏à‡∏≠‡∏î‡∏±‡∏ö
let wakeLock = null;

async function enableWakeLock() {
    try {
        wakeLock = await navigator.wakeLock.request('screen');
        document.getElementById("statusText").textContent = "üîí ‡∏´‡∏ô‡πâ‡∏≤‡∏à‡∏≠‡∏à‡∏∞‡πÑ‡∏°‡πà‡∏î‡∏±‡∏ö‡πÅ‡∏•‡πâ‡∏ß";
        wakeLock.addEventListener('release', () => {
            document.getElementById("statusText").textContent = "‚ö†Ô∏è ‡∏´‡∏ô‡πâ‡∏≤‡∏à‡∏≠‡∏Å‡∏•‡∏±‡∏ö‡∏°‡∏≤‡∏î‡∏±‡∏ö‡πÑ‡∏î‡πâ‡∏≠‡∏µ‡∏Å";
        });
    } catch (err) {
        document.getElementById("statusText").textContent = "‚ùå ‡∏°‡∏∑‡∏≠‡∏ñ‡∏∑‡∏≠‡πÑ‡∏°‡πà‡∏£‡∏≠‡∏á‡∏£‡∏±‡∏ö Wake Lock";
    }
}

document.addEventListener("visibilitychange", () => {
    if (wakeLock && document.visibilityState === "visible") enableWakeLock();
});
</script>

</body>
</html>

